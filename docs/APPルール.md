# APPルール

## Calculation.html

### 価格計算ロジック（詳細）
- **共通**
  - 金額の表示は `formatNumber(number)` で3桁区切り。税込は税抜に1.1を乗算し `Math.floor`。
  - 各商品の値引きは `calculateDiscount(price, discountValue, quantity?)` を適用。
    - 値引きが0または未入力なら0。
    - 値引きが100未満の数値 → パーセント割引（例: 10 → 10%）。切り捨て。
    - 値引きが100以上の数値 → 固定金額割引。通常商品は数量×固定金額、基礎は数量1固定。
    - 割引上限は元金額まで。

- **通常商品（`productsData`）の計算** `calculateProduct(productId, 'product')`
  - 入力: 大項目 `goods{n}`、小項目 `list{n}`、数量 `quantity{n}`、値引 `discount_value{n}`。
  - 基本金額の算出:
    - 商品データに `base` があれば初期値に加算。
    - `areaThreshold` のある商品は、数量がしきい値を超えた分のみ単価 `price` を加算。
    - `areaThreshold` がない商品は `price × 数量` を加算。
  - 特殊ロジック:
    - カビ（`そのほか/カビ` および `消毒/カビ`）は `calculateKabiPrice(quantity, selectedProducts)` を使用。
      - 価格は条件で 2500/1700/1000 に切替。
      - 条件1: 選択中商品に `category === "消毒"` があれば 1000。
      - 条件2: それ以外で、選択中商品に (新規工事 または 追加工事) の基礎商品（`item` に「基礎」または「クラック」を含む）や、`item` に `DC2`/`60` を含むものがあれば 1700。
      - どちらにも該当しなければ 2500。
    - BM（`そのほか/BM`）は `calculateBMPrice(quantity, selectedProducts)` を使用。
      - 既存の割引条件に一致（データ `discountConditions`）または、選択中商品に外基礎/中基礎があれば 単価 2800。該当しなければ 3300。
    - `床下機器/SO2買` は、他の選択商品に `item` に `DC2` または `60` を含む商品があれば単価 83000、それ以外は商品定義の単価。
  - 値引きの適用:
    - 算出した税抜合計に対して `calculateDiscount` を適用し税抜・税込を決定。
  - 表示更新:
    - `#price_ex_tax{n}`, `#price_in_tax{n}` を更新。
    - `updateSelectedProducts` を呼び、サマリーに反映。

- **基礎商品（`kisoProductsData`）の計算** `calculateProduct(productId, 'kiso-product')`
  - 入力: 大項目 `kiso-goods{n}`、小項目 `kiso-list{n}`、高さ `kiso-height{n}`、長さ（または個数） `kiso-length{n}`、値引 `kiso-discount_value{n}`。
  - 金額算出:
    - 商品データから高さ別価格を取得。`基本価格` と `長さ加算` を参照。
    - クラック系（カテゴリが「クラック」）は、`basePrice = 長さ加算 × 個数`（`length` を個数と解釈）。
    - 通常の基礎は、`基本長さ` を超えた超過分のみ `長さ加算 × 超過長さ` を `基本価格` に加算。
    - 値引は `calculateDiscount(basePrice, discountValue, 1)`（基礎は数量1扱い）。
    - 税込は `Math.floor(税抜×1.1)`。
    - 表示名は「`{item} {height}cm {length}m`」または「`{item} {height}cm {length}個`（クラック）」。

- **サマリーとセット割** `updateSummary()`
  - 対象は金額が正の `selectedProducts`。
  - 商品名の構成:
    - 通常商品は `item` をそのまま。
    - 基礎商品は `item` 全文から主要名を抽出。
      - クラックは「外クラック／中片クラック／中両面クラック」の語を抽出。
      - 基礎は「外基礎／中基礎」を抽出し、カテゴリが「追加工事」の場合は末尾に「追」を付加。
    - 値引きがある場合は「▲パーセントまたは円」表記を商品名末尾に付加。
  - 基礎セット割: 外基礎と中基礎が両方ある場合、サマリー上の商品名は「`(外基礎・中基礎)▲セット`」として括り、税抜合計から 40,000 円を控除。
  - 管理費（管有）: チェックオンで商品名末尾に「・管有」、税抜+20,000、税込+22,000 を加算。
  - コピー用の3グループを表示: 「商品」「数量」「合計金額(抜)」。


### 商品名転記ロジック
- `updateSelectedProducts` で内部配列 `selectedProducts` に編集結果を集約し、`updateSummary` が表示用の商品名を合成。
- 合成規則:
  - 基礎の「外基礎／中基礎」は主要名のみ（「追加工事」は末尾に「追」）。
  - クラックは「外クラック／中片クラック／中両面クラック」に正規化。
  - 値引がある場合、`discountValue < 100` なら「▲{%}」、`>= 100` なら「▲{金額}」。
  - 基礎セット割時は `(外基礎・中基礎)▲セット` とし、他商品と「・」で連結。管有オンで「・管有」を末尾に付ける。


## ReverseCheck.html

### 貼り付けテキスト分割ロジック
- 入力形式: Excelから「商品名・数量・金額」の3列を改行区切りで貼付。
- 行分解: `lines = input.split('\n').filter(Boolean)`。
- 列分解: `const [name, qty, price] = line.split(/\t|\s{2,}/)`。
- 商品名分割:
  - 通常は「・/･」で分割。
  - ただし、括弧の中の「・」は商品区切りに扱わない。`splitProductsWithParentheses` でネスト対応しつつ括弧外のみ分割。
  - 特殊: `(外基礎・中基礎)▲セット` が含まれる、または外基礎/中基礎が併記されている場合は、`['外基礎', '中基礎', '管有(あれば)']` のように明示的に分割。
- 数量分割: `qty.split(/[\/・･]/)` で商品ごとの数量を対応付け。基礎・クラックは `30*20` のように「高さ*長さ（または個数）」を許容。

### テーブル内役割
- 行ごとに1テーブルを描画。列は「商品名」「値引」「システム商品名（確定/候補/手入力）」「数量」「金額(税抜)」。
- システム商品名セルの優先順位:
  - 部分一致候補が複数 → セレクトボックス表示（候補は通常商品・基礎商品両方から類似度で抽出）。
  - 一致なし → 入力フィールド表示（ユーザーが直接修正）。
  - 完全一致 → 文字列で確定表示。
- 非表示保持: 値引・数量は隣接セルに hidden input として保持し、再描画で復元。
- 合計欄: 「貼付金額」「計算金額」「差額」「一致/不一致」を表示。税抜同士で比較し、完全一致で「一致」。

### 商品名抽出ロジック（値引きの概念）
- 値引表記の抽出 `parseDiscountFromName(name)`:
  - `(外基礎・中基礎)▲セット` を検出 → 40000 円割引（特例）。
  - `▲JA` → 10% 割引。
  - `▲{n}%`/`▲{n}％` → n% 割引。
  - `▲{n}円` → n 円割引。
- 値引表記の除去 `removeDiscountFromName(name)`:
  - 上記の表記を削除し、検索用の商品名に正規化。末尾の「追」は検索時に「新」に変換、`/^BM.*/` は `BM` に正規化。
- グループ括弧 `parseGroupDiscount(name)`:
  - 外基礎・中基礎が含まれるときはスキップ（基礎専用処理に委譲）。
  - それ以外は、カッコ内の「・」区切りを展開し、カッコの外に続く修飾語（`新`/`買`/`▲%`/`▲円`/`▲JA`）を全要素に反映して展開。
- 基礎・クラックの数量解釈:
  - `parseKisoQuantity("H*L")` が高さを 30/40/50/60/70/80 のクラスに丸め、長さ/個数を抽出。
  - クラックは個数として `L` を用い、基礎は長さとして `L` を用いる。個数のみのとき、同一行にある基礎の高さを流用、なければ 30cm をデフォルト。
- 金額計算の適用:
  - 通常商品は `goodsData` 定義に基づき、`base`/`price`/`areaThreshold` で算定。
  - `カビ` は同一行の商品群で `DC2`/`MJ60`/`消毒` 等を判定し 2500/1700/1000 を切替。
  - `BM` は同一行の商品群に基礎や特定機器があれば 2800、それ以外 3300。
  - `SO2買` は同一行の商品群に `DC2` か `MJ60` があれば 83,000、それ以外は定義単価。
  - 基礎は高さ別 `基本価格` に長さ超過分の `長さ加算` を足す。クラックは `長さ加算 × 個数`。
  - 値引は行内の商品ごとに個別に適用。基礎セット割（明示的なセット表記あり）の場合は 40,000 円を小計から控除（個別値引と二重適用しない）。


